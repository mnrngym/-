// 送信ボタン：メール送信 → サンクス画面
document.getElementById('submitBtn').addEventListener('click', async ()=> {
  // 送信内容の整形
  const nickname = document.getElementById('nickname').value || '';
  const answers = Object.fromEntries(Q.map(([id])=>[id-3, states.get(id) ?? null]));
  const classified = classify();

  const lines = [];
  lines.push(`名前/ニックネーム: ${nickname}`);
  for (const [id, text] of Q) {
    const v = states.get(id);
    const label = v===2 ? 'はい' : v===1 ? 'どちらでもない' : v===0 ? 'いいえ' : '未回答';
    lines.push(`${id - 3}. ${text} -> ${label}`);
  }
  const textBody = lines.join('\n');

  // 1) Formspree 等のエンドポイントが設定されていれば JSON でPOST
  if (FORMSPREE_ENDPOINT) {
    try {
      const res = await fetch(FORMSPREE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          nickname,
          mail_to: MAIL_TO,
          answers,
          classified,
          raw_text: textBody
        })
      });
      if (res.ok) {
        const base = location.origin + location.pathname;
        location.href = base + '?thanks=1';
        return;
      }
    } catch (e) {
      // 失敗時は mailto にフォールバック
    }
  }

  // 2) エンドポイント未設定 or 失敗時：ユーザーのメーラーを開く
  const subject = encodeURIComponent('宗教相性診断フォーム 送信');
  const body = encodeURIComponent(textBody + '\n\n(このメールはGitHub Pagesから送信)');
  const mailto = `mailto:${encodeURIComponent(MAIL_TO)}?subject=${subject}&body=${body}`;
  window.location.href = mailto;

  // メーラー起動後もサンクス画面を表示
  setTimeout(()=>{
    const base = location.origin + location.pathname;
    location.href = base + '?thanks=1';
  }, 500);
});
